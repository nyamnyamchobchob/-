<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>한국사 능력검정 퀴즈</title>
<style>
:root{--bg:#fbfbfd;--card:#fff;--accent:#0b63d3;--success:#2e7d32;--danger:#c62828}
html,body{margin:0;padding:0;height:100%;font-family:Inter,"Apple SD Gothic Neo","Malgun Gothic",sans-serif;background:var(--bg);color:#111}
.wrap{max-width:900px;margin:0 auto;padding:18px}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
h1{font-size:1.25rem;margin:0}
.controls{display:flex;gap:8px;flex-wrap:wrap}
button,label.input-btn{background:var(--card);border:1px solid #ddd;padding:8px 12px;border-radius:8px;font-size:1rem}
button:hover,label.input-btn:hover{filter:brightness(.98);cursor:pointer}
#menu{margin-top:18px;display:flex;flex-wrap:wrap;gap:8px}
.kw-btn{min-width:140px;text-align:left;display:flex;flex-direction:column;padding:10px;border-radius:10px;border:1px solid #e6e7ea;background:#fff}
.kw-title{font-weight:600}
.kw-stats{font-size:.85rem;color:#666}
#quiz{margin-top:18px;padding:14px;border-radius:10px;background:var(--card);border:1px solid #e6e7ea;min-height:120px;display:flex;flex-direction:column}
.question{font-size:1.05rem;margin-bottom:12px}
.options{display:flex;flex-direction:column;gap:8px}
.opt{padding:8px 10px;border-radius:8px;border:1px solid #ddd;background:#fff;display:flex;align-items:center}
.opt.disabled{opacity:.6;pointer-events:none}
.opt.correct{border-color:var(--success);background:rgba(46,125,50,0.06)}
.opt.wrong{border-color:var(--danger);background:rgba(198,40,40,0.05)}
.meta{margin-top:10px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.small{font-size:.9rem;color:#666}
.kbd{font-family:monospace;background:#f4f6fb;padding:4px 8px;border-radius:6px}
.center{display:flex;gap:8px;flex-wrap:wrap}
#backBtn{background:#999;color:#fff;border:none;padding:6px 12px;border-radius:6px;}
@media (max-width:480px){.kw-btn{min-width:48%;font-size:.95rem}.controls{flex-direction:column;align-items:stretch}button,label.input-btn{width:100%}}
.next-btn{background:var(--accent);color:#fff;border:none;padding:8px 16px;border-radius:8px;font-size:1rem;cursor:pointer;margin-top:12px;align-self:flex-start;transition:all 0.2s ease}
.next-btn:hover{filter:brightness(0.9);}
</style>
</head>
<body>
<div class="wrap">
<header>
  <div>
    <h1>한국사 능력검정 퀴즈</h1>
    <div class="small">Session 모드: 키워드 선택 시 연속 문제 풀이 가능</div>
  </div>
  <div class="controls">
    <label class="input-btn">Load data <input id="fileInput" type="file" accept="application/json,text/csv" style="display:none"></label>
    <button id="randomBtn">랜덤 문제</button>
    <button id="resetStatsBtn">통계 초기화</button>
  </div>
</header>

<main>
  <div id="menu"></div>
  <div id="quiz"></div>
  <div class="meta">
    <div id="currentKeyword" class="small"></div>
    <div id="progress" class="small"></div>
    <button id="backBtn" style="display:none">메뉴로 돌아가기</button>
  </div>
</main>

<footer>
  <div>데이터 파일 포맷: JSON 또는 CSV. 예: <span class="kbd">고조선,고인돌|비파형 동검|위만조선</span></div>
</footer>
</div>

<script>
// STEP 0: 기본 데이터
const DEFAULT_DATA=[
  {keyword:"고조선",data:["고인돌","비파형 동검","위만조선","우거왕","왕검성"]},
  {keyword:"삼국시대",data:["고구려","백제","신라","광개토대왕","근초고왕"]},
  {keyword:"조선시대",data:["세종대왕","훈민정음","붕당","영정법","사화"]}
];
let DATA=[], stats={}, sessionQueue=[], currentQuestion=null, sessionMeta={keyword:null,isRandom:false};
const STORAGE_KEY='kh_quiz_stats_v6';
const CHO=["ㄱ","ㄲ","ㄴ","ㄷ","ㄸ","ㄹ","ㅁ","ㅂ","ㅃ","ㅅ","ㅆ","ㅇ","ㅈ","ㅉ","ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"];

// 유틸리티
function sample(arr,n=1){ const copy=arr.slice(); const out=[]; for(let i=0;i<n&&copy.length;i++){ const idx=Math.floor(Math.random()*copy.length); out.push(copy.splice(idx,1)[0]); } return out; }
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
function uniq(arr){ return Array.from(new Set(arr)); }
function chosungOf(str){ let out=''; for(const ch of str){ const code=ch.charCodeAt(0); if(code>=0xAC00&&code<=0xD7A3){ out+=CHO[Math.floor((code-0xAC00)/588)]||ch; } else if(/[A-Za-z0-9]/.test(ch)){ out+=ch; } else if(ch.trim()===""){ out+=' '; } else out+=ch; } return out.replace(/\s+/g,'').trim(); }

// 로컬스토리지 통계
function loadStats(){ try{ stats=JSON.parse(localStorage.getItem(STORAGE_KEY))||{}; }catch(e){ stats={}; } }
function saveStats(){ localStorage.setItem(STORAGE_KEY,JSON.stringify(stats)); }
function resetStats(){ stats={}; saveStats(); renderMenu(); }

// 메뉴 렌더링
function renderMenu(){
  loadStats();
  document.getElementById('menu').style.display='flex';
  document.getElementById('quiz').style.display='none';
  document.getElementById('backBtn').style.display='none';
  document.getElementById('currentKeyword').textContent='';
  document.getElementById('progress').textContent='';
  const menu=document.getElementById('menu'); menu.innerHTML='';
  if(!DATA.length){ menu.innerHTML='<div class="small">데이터 없음</div>'; return; }
  DATA.forEach(d=>{
    if(!stats[d.keyword]) stats[d.keyword]={correct:0,total:0};
    const btn=document.createElement('button'); btn.className='kw-btn';
    btn.innerHTML=`<div class="kw-title">${d.keyword}</div><div class="kw-stats">${stats[d.keyword].correct}/${stats[d.keyword].total}</div>`;
    btn.onclick=()=>startSession(d.keyword,false);
    menu.appendChild(btn);
  });
}

// 세션 큐 생성
function createSessionQueueForKeyword(keyword){
  const item=DATA.find(d=>d.keyword===keyword); if(!item) return [];
  const questions=[];
  item.data.forEach(val=>{
    const type=Math.random()<0.5?'chosung':'match';
    if(type==='chosung') questions.push({keyword,val,type:'chosung'});
    else{ 
      const correctSet=[val];
      if(item.data.length>1 && Math.random()<0.25) correctSet.push(...sample(item.data.filter(x=>x!==val),1));
      questions.push({keyword,correctSet,type:'match'});
    }
  });
  return shuffle(questions);
}
function createSessionQueueRandom(){
  let all=[];
  DATA.forEach(item=>{
    item.data.forEach(val=>{
      const type=Math.random()<0.5?'chosung':'match';
      if(type==='chosung') all.push({keyword:item.keyword,val,type:'chosung'});
      else{
        const correctSet=[val];
        if(item.data.length>1 && Math.random()<0.25) correctSet.push(...sample(item.data.filter(x=>x!==val),1));
        all.push({keyword:item.keyword,correctSet,type:'match'});
      }
    });
  });
  return shuffle(all);
}

// 세션 시작
function startSession(keyword,isRandom){
  sessionQueue=isRandom?createSessionQueueRandom():createSessionQueueForKeyword(keyword);
  sessionMeta={keyword,isRandom};
  document.getElementById('menu').style.display='none';
  document.getElementById('quiz').style.display='flex';
  document.getElementById('backBtn').style.display='inline-block';
  nextQuestion();
}

// 진행 표시
function updateProgress(){
  const left=sessionQueue.length + (currentQuestion?1:0);
  document.getElementById('currentKeyword').textContent=sessionMeta.keyword?`문제: ${sessionMeta.keyword}`:'';
  document.getElementById('progress').textContent=left?`남은 문제: ${left}`:'';
}

// 다음 문제
function nextQuestion(){
  if(sessionQueue.length===0){ 
    showSessionEnd(); 
    return; 
  }
  currentQuestion=sessionQueue.shift();
  updateProgress();
  renderQuestion(currentQuestion);
}

// 세션 종료 처리
function showSessionEnd(){
  const quiz=document.getElementById('quiz'); quiz.innerHTML='';
  const msg=document.createElement('div'); msg.className='question'; msg.textContent='모든 문제 완료!'; quiz.appendChild(msg);
  const div=document.createElement('div'); div.className='center';
  const restart=document.createElement('button'); restart.textContent='다시 시작';
  const toMenu=document.createElement('button'); toMenu.textContent='메뉴로 돌아가기';
  
  restart.onclick=()=>{ 
    sessionQueue = sessionMeta.isRandom ? createSessionQueueRandom() : createSessionQueueForKeyword(sessionMeta.keyword);
    nextQuestion();
  };
  
  toMenu.onclick=()=>{ renderMenu(); sessionQueue=[]; currentQuestion=null; sessionMeta={keyword:null,isRandom:false}; };
  
  div.appendChild(restart); 
  div.appendChild(toMenu); 
  quiz.appendChild(div);
  document.getElementById('progress').textContent='';
}

// 문제 렌더링
function renderQuestion(q){
  const quiz=document.getElementById('quiz'); quiz.innerHTML='';
  if(q.type==='chosung') renderChosung(q);
  else renderMatch(q);
}

function renderChosung(q){
  const quiz=document.getElementById('quiz'); 
  const question=document.createElement('div'); question.className='question'; question.textContent=`초성: ${chosungOf(q.val)}`;
  quiz.appendChild(question);
  const optionsDiv=document.createElement('div'); optionsDiv.className='options'; quiz.appendChild(optionsDiv);
  const opts=shuffle(uniq([q.val].concat(collectDistractors(new Set([q.val]),3))));
  opts.forEach(opt=>{
    const div=document.createElement('div'); div.className='opt'; div.textContent=opt;
    div.onclick=()=>handleAnswer(optionsDiv,q.keyword,opt===q.val,[div],[q.val]);
    optionsDiv.appendChild(div);
  });
}

function renderMatch(q){
  const quiz=document.getElementById('quiz');
  const correctSet=new Set(q.correctSet);
  const isMulti=correctSet.size>1;
  const question=document.createElement('div'); question.className='question';
  question.textContent=`${q.keyword}에 알맞은 것은? ${isMulti?'(중복 선택 가능)':''}`;
  quiz.appendChild(question);
  const optionsDiv=document.createElement('div'); optionsDiv.className='options'; quiz.appendChild(optionsDiv);
  const opts=shuffle(uniq([...correctSet,...collectDistractors(correctSet,Math.max(0,4-correctSet.size))]));
  opts.forEach(opt=>{
    if(isMulti){
      const label=document.createElement('label'); label.className='opt';
      const cb=document.createElement('input'); cb.type='checkbox'; cb.style.marginRight='8px'; label.appendChild(cb);
      const span=document.createElement('span'); span.textContent=opt; label.appendChild(span);
      optionsDiv.appendChild(label);
      cb.onchange=()=>checkMulti(optionsDiv, correctSet,q.keyword);
    }else{
      const div=document.createElement('div'); div.className='opt'; div.textContent=opt;
      div.onclick=()=>handleAnswer(optionsDiv,q.keyword,correctSet.has(opt),[div],Array.from(correctSet));
      optionsDiv.appendChild(div)
    }
  });
}

// 정답 처리
function handleAnswer(container,keyword,isCorrect,clicked,correctAnswers){
  Array.from(container.children).forEach(c=>c.classList.add('disabled'));
  clicked.forEach(c=>isCorrect?c.classList.add('correct'):c.classList.add('wrong'));
  Array.from(container.children).forEach(c=>{
    const text=c.querySelector('span')?.textContent.trim()||c.textContent.trim();
    if(correctAnswers.includes(text)) c.classList.add('correct');
  });
  updateStats(keyword,isCorrect);
  showNextButton(container); // 다음 문제 버튼 표시
}

function checkMulti(container,correctSet,keyword){
  const checked=Array.from(container.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.parentElement.querySelector('span').textContent.trim());
  const checkedSet=new Set(checked);
  const allCorrect=Array.from(correctSet).every(c=>checkedSet.has(c));
  const anyWrong=checked.some(c=>!correctSet.has(c));
  if(allCorrect || anyWrong){ handleAnswer(container,keyword,allCorrect&&!anyWrong,[],Array.from(correctSet)); }
}

// 다음 문제 버튼
function showNextButton(container){
  const btn=document.createElement('button'); 
  btn.className='next-btn'; 
  btn.textContent='다음 문제';
  btn.onclick=nextQuestion;
  container.appendChild(btn);
}

// 오답 수집
function collectDistractors(excludeSet,count){ return sample(DATA.flatMap(d=>d.data).filter(x=>!excludeSet.has(x)),count); }

// 이벤트
document.getElementById('fileInput').addEventListener('change',async(ev)=>{
  const f=ev.target.files[0]; if(!f) return; 
  const text=await f.text(); 
  try{ const parsed=JSON.parse(text); if(Array.isArray(parsed)){ DATA=parsed.map(i=>({keyword:i.keyword,data:i.data.slice()})); alert('JSON 로드'); renderMenu(); return; } }catch(e){}
  const csv=text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l).map(line=>{
    const [k,...rest]=line.split(','); const data=(rest.join(',').includes('|')?rest.join(',').split('|'):rest.join(',').split(';')).map(s=>s.trim()).filter(s=>s); return {keyword:k.trim(),data};
  });
  if(csv.length){ DATA=csv; alert('CSV 로드'); renderMenu(); return; } alert('파일 인식 불가'); 
});

document.getElementById('backBtn').onclick=()=>{ if(confirm('세션 종료 후 메뉴로 돌아가시겠어요?')){ renderMenu(); sessionQueue=[]; currentQuestion=null; sessionMeta={keyword:null,isRandom:false}; } };
document.getElementById('randomBtn').onclick=()=>startSession('랜덤',true);
document.getElementById('resetStatsBtn').onclick=()=>{ if(confirm('모든 통계 초기화?')) resetStats(); };

// 통계 업데이트
function updateStats(keyword,correct){ stats[keyword]=stats[keyword]||{correct:0,total:0}; stats[keyword].total++; if(correct) stats[keyword].correct++; saveStats(); renderMenu(); }

// 초기화
function init(){ loadStats(); DATA=JSON.parse(JSON.stringify(DEFAULT_DATA)); renderMenu(); }
init();
</script>
</body>
</html>
