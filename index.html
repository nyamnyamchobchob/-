<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>한국사 퀴즈</title>
<style>
body{font-family:sans-serif;max-width:700px;margin:20px auto;background:#f9f9f9;padding:10px;}
button{padding:8px 16px;margin:4px;border-radius:8px;cursor:pointer;}
.opt{padding:6px;border:1px solid #ccc;border-radius:8px;margin:4px;cursor:pointer;}
.opt.disabled{pointer-events:none;opacity:0.6;}
.opt.correct{background:#c8f7c5;}
.opt.wrong{background:#f7c5c5;}
.next-btn{display:block;margin-top:12px;}
</style>
</head>
<body>

<h2>한국사 퀴즈</h2>
<input type="file" id="fileInput">
<button id="randomBtn">랜덤 시작</button>
<button id="resetStatsBtn">통계 초기화</button>
<hr>
<div id="menu"></div>
<hr>
<div id="quiz"></div>

<script>
// ===== 데이터 & 통계 =====
let DATA=[
  {keyword:"고조선",data:["고인돌","비파형 동검","위만조선"]},
  {keyword:"삼국시대",data:["고구려","백제","신라"]}
];
let stats={};
let sessionQueue=[];
let sessionMeta={keyword:null,isRandom:false};

// 초성
const CHO=["ㄱ","ㄲ","ㄴ","ㄷ","ㄸ","ㄹ","ㅁ","ㅂ","ㅃ","ㅅ","ㅆ","ㅇ","ㅈ","ㅉ","ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"];
function chosungOf(str){
  let out='';
  for(const ch of str){
    const code=ch.charCodeAt(0);
    if(code>=0xAC00 && code<=0xD7A3){ out+=CHO[Math.floor((code-0xAC00)/588)]; }
    else if(/[A-Za-z0-9]/.test(ch)) out+=ch;
    else out+=ch;
  }
  return out.replace(/\s+/g,'').trim();
}

// ===== 통계 =====
function loadStats(){const s=localStorage.getItem('stats'); if(s) stats=JSON.parse(s);}
function saveStats(){localStorage.setItem('stats',JSON.stringify(stats));}
function resetStats(){stats={};saveStats();renderMenu();}

// ===== 메뉴 =====
function renderMenu(){
  const menu=document.getElementById('menu');
  menu.innerHTML='<h3>키워드 선택</h3>';
  DATA.forEach(item=>{
    const btn=document.createElement('button');
    btn.textContent=`${item.keyword} (${stats[item.keyword]?.correct||0}/${stats[item.keyword]?.total||0})`;
    btn.onclick=()=>startSession(item.keyword);
    menu.appendChild(btn);
  });
}

// ===== 세션 시작 =====
function startSession(keyword,isRandom=false){
  sessionMeta={keyword,isRandom};
  if(isRandom){
    const allQ=DATA.flatMap(d=>d.data.map(v=>({keyword:d.keyword,val:v,type:Math.random()<0.5?'chosung':'match'})));
    sessionQueue=shuffle(allQ);
  }else{
    const item=DATA.find(d=>d.keyword===keyword);
    sessionQueue=shuffle(item.data.map(v=>({keyword:item.keyword,val:v,type:Math.random()<0.5?'chosung':'match'})));
  }
  nextQuestion();
}

// ===== 유틸 =====
function shuffle(a){return a.map(v=>[Math.random(),v]).sort((x,y)=>x[0]-y[0]).map(x=>x[1]);}

// ===== 문제 진행 =====
function nextQuestion(){
  const q=sessionQueue.shift();
  if(!q){showSessionEnd(); return;}
  renderQuestion(q);
}

// 문제 렌더
function renderQuestion(q){
  const quiz=document.getElementById('quiz');
  quiz.innerHTML='';
  const question=document.createElement('div');
  question.textContent=q.type==='chosung'?`초성: ${chosungOf(q.val)}`:`${q.keyword}에 맞는 것은?`;
  quiz.appendChild(question);

  const optionsDiv=document.createElement('div');
  quiz.appendChild(optionsDiv);

  // 보기 생성 (정답+오답)
  const allItems=DATA.flatMap(d=>d.data);
  let opts=[q.val];
  while(opts.length<4){
    const candidate=allItems[Math.floor(Math.random()*allItems.length)];
    if(!opts.includes(candidate)) opts.push(candidate);
  }
  opts=shuffle(opts);

  opts.forEach(opt=>{
    const div=document.createElement('div');
    div.className='opt';
    div.textContent=opt;
    div.onclick=()=>handleAnswer(optionsDiv,q.keyword,opt===q.val,[div],[q.val]);
    optionsDiv.appendChild(div);
  });
}

// 정답 처리
function handleAnswer(container,keyword,isCorrect,clicked,correctAnswers){
  Array.from(container.children).forEach(c=>c.classList.add('disabled'));
  clicked.forEach(c=>isCorrect?c.classList.add('correct'):c.classList.add('wrong'));
  Array.from(container.children).forEach(c=>{
    if(correctAnswers.includes(c.textContent.trim())) c.classList.add('correct');
  });
  stats[keyword]=stats[keyword]||{correct:0,total:0};
  stats[keyword].total++;
  if(isCorrect) stats[keyword].correct++;
  saveStats();
  showNextButton(container);
}

// 다음 버튼
function showNextButton(container){
  const btn=document.createElement('button');
  btn.className='next-btn';
  btn.textContent='다음 문제';
  btn.onclick=nextQuestion;
  container.appendChild(btn);
}

// 세션 종료
function showSessionEnd(){
  const quiz=document.getElementById('quiz');
  quiz.innerHTML='<h3>모든 문제 완료!</h3><button onclick="renderMenu()">메뉴로 돌아가기</button>';
}

// ===== CSV/JSON 업로드 =====
document.getElementById('fileInput').addEventListener('change', async (ev) => {
  const f = ev.target.files[0];
  if (!f) return;
  const text = await f.text();

  try {
    // JSON 처리
    const parsed = JSON.parse(text);
    if (Array.isArray(parsed)) {
      DATA = parsed.map(i => ({ keyword: i.keyword, data: i.data.slice() }));
      alert('JSON 로드 완료');
      renderMenu();
      return;
    }
  } catch (e) {
    // CSV 처리
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l);
    const csvData = lines.map(line => {
      const parts = line.split(',');
      const keyword = parts[0].trim();
      const items = parts.slice(1).join(','); // 뒤에 있는 모든 걸 합침
      let data = [];
      if (items.includes('|')) {
        data = items.split('|').map(s => s.trim());
      } else {
        data = parts.slice(1).map(s => s.trim());
      }
      return { keyword, data };
    }).filter(d => d.keyword && d.data.length);

    if (csvData.length) {
      DATA = csvData;
      alert('CSV 로드 완료');
      renderMenu();
      return;
    }
  }

  alert('파일 형식 인식 실패');
});


// 랜덤 시작 & 통계 초기화
document.getElementById('randomBtn').onclick=()=>startSession('랜덤',true);
document.getElementById('resetStatsBtn').onclick=()=>{if(confirm('통계 초기화?'))resetStats();};

// 초기화
loadStats();
renderMenu();
</script>

</body>
</html>

